# 🏭 מערכת איסוף נתונים תעשייתיים MTConnect

## 📋 סקירת המערכת

מערכת MTConnect היא פתרון מקיף לאיסוף, עיבוד וניטור נתונים של ציוד תעשייתי בזמן אמת. המערכת פועלת על ארכיטקטורת Edge-to-Cloud, המבטיחה איסוף נתונים מקומי אמין ואחסון מרכזי בענן.

## 🏗️ ארכיטקטורת המערכת

```
┌─────────────────────────────────────────────────────────────┐
│                     חלק הענן (Railway)                      │
├─────────────────────────────────────────────────────────────┤
│  ☁️ Cloud API (NestJS)          📊 Dashboard               │
│  - קבלת נתונים מ-Edge           - ממשק ניטור ווב            │
│  - REST API endpoints           - עדכונים בזמן אמת         │
│  - אימות ותיעוד                - סטטיסטיקות מכונות         │
│                                                             │
│  🗄️ MongoDB Atlas                                          │
│  - אחסון סדרות זמן              - אינדקסים לחיפוש          │
│  - מטא-נתונים של מכונות          מהיר                      │
│  - היסטוריית פעולות            - קנה מידה אוטומטי           │
└─────────────────────────────────────────────────────────────┘
                                │
                          HTTPS/Internet
                                │
┌─────────────────────────────────────────────────────────────┐
│                     חלק מקומי (Edge)                        │
├─────────────────────────────────────────────────────────────┤
│  🚀 Edge Gateway (Node.js/TypeScript)                      │
│  - איסוף נתונים מכל המקורות                                │
│  - צבירה ועיבוד מקדים                                      │  
│  - שליחה לענן כל 10 שניות                                  │
│  - REST API מקומי (פורט 3555)                              │
│  - דשבורד ווב מקומי                                        │
└─────────────────────────────────────────────────────────────┘
                    │                      │
              ┌─────────────┐        ┌─────────────┐
              │   FANUC     │        │    ADAM     │
              │   מכונות    │        │   מונים     │
              └─────────────┘        └─────────────┘
```

## 🔧 רכיבי המערכת

### 1. 🏭 ציוד תעשייתי

#### מכונות CNC FANUC (8 יחידות)
- **M_1_XD-20** - מחרטה XD-20
- **M_2_SR_26** - כרסמת SR-26  
- **M_3_XD_38** - מחרטה XD-38
- **M_4_SR_10** - כרסמת SR-10
- **M_5_DT_26** - מקדחה DT-26
- **M_6_SR_21** - כרסמת SR-21
- **M_7_SR_23** - כרסמת SR-23
- **M_8_SR_25** - כרסמת SR-25

**נתונים נאספים:**
- כמות חלקים מיוצרים
- מספר תוכנית פעילה
- סטטוס ביצוע (ACTIVE/STOPPED/READY)
- זמן מחזור
- סטטוס חיבור

#### מוני חלקים ADAM-6050 (10 יחידות)
- **SR-22** - מונה קו SR-22
- **SB-16** - מונה קו SB-16
- **BT-38** - מונה קו BT-38
- **K-162** - מונה קו K-162
- **K-163** - מונה קו K-163
- **L-20** - מונה קו L-20
- **K-16** - מונה קו K-16
- **SR-20** - מונה קו SR-20
- **SR-32** - מונה קו SR-32
- **SR-24** - מונה קו SR-24

**פרוטוקול:** Modbus TCP (192.168.1.120:502)
**נתונים נאספים:**
- מוני ייצור חלקים
- זמן מחזור (עבור חלק מהקווים)
- סטטוס חיבור

### 2. 🖥️ Edge Gateway (שרת מקומי)

**טכנולוגיות:** Node.js, TypeScript, Express.js
**פורט:** 3555
**קובץ:** `src/main.ts`

**פונקציות עיקריות:**
- איסוף נתונים ממתאמי FANUC דרך פרוטוקול SHDR
- קריאת נתונים ADAM-6050 דרך Modbus TCP
- צבירה ואימות נתונים
- שליחה לענן כל 10 שניות
- REST API מקומי לניטור
- דשבורד ווב לצפייה מקומית

**API Endpoints:**
- `GET /api/machines` - רשימת כל המכונות עם נתונים
- `GET /dashboard-new.html` - ממשק ווב

### 3. ☁️ Cloud API (Railway)

**טכנולוגיות:** NestJS, TypeScript, MongoDB
**URL:** https://mtconnect-core-production.up.railway.app
**קבצים:** `apps/cloud-api/`

**פונקציות עיקריות:**
- קבלת נתונים מ-Edge Gateway
- שמירה ב-MongoDB Atlas
- REST API עבור אפליקציות לקוח
- אימות ותיעוד נתונים
- טיפול בשגיאות והתאוששות

**API Endpoints:**
- `POST /api/ext/data` - קבלת נתונים מ-Edge Gateway
- `GET /api/dashboard/machines` - קבלת נתונים לדשבורד
- `GET /dashboard-new.html` - דשבורד ווב

### 4. 🗄️ בסיס נתונים (MongoDB Atlas)

**קולקשן:** `machinedatas`
**מבנה מסמך:**
```json
{
  "timestamp": "2025-01-29T13:10:42.115Z",
  "metadata": {
    "edgeGatewayId": "ANDREY-PC-edge-gateway",
    "machineId": "M_2_SR_26",
    "machineName": "SR-26", 
    "machineType": "FANUC"
  },
  "data": {
    "partCount": 1999667,
    "program": "1244-01-1",
    "executionStatus": "ACTIVE",
    "cycleTime": 20.19,
    "cycleTimeConfidence": "גבוה"
  }
}
```

**אינדקסים:**
- `metadata.machineId` + `timestamp` (לחיפוש מהיר של נתונים אחרונים)
- `metadata.edgeGatewayId` + `timestamp` (לקיבוץ לפי Edge Gateway)

### 5. 📊 Dashboard (ממשק ווב)

**טכנולוגיות:** HTML5, CSS3, JavaScript (Vanilla)
**קובץ:** `apps/cloud-api/public/dashboard-new.html`

**תכונות:**
- הצגת כל 18 המכונות בזמן אמת
- סטטיסטיקות: מקוון/לא מקוון, ספירה כוללת
- מידע מפורט לכל מכונה
- רענון אוטומטי כל 5 שניות
- עיצוב רספונסיבי למכשירים ניידים

**נתונים מוצגים:**
- סטטוס חיבור (מקוון/לא מקוון)
- כמות חלקים מיוצרים
- מספר תוכנית פעילה (FANUC)
- סטטוס ביצוע (ACTIVE/STOPPED/READY)
- זמן מחזור
- חותמת זמן עדכון אחרון

## 🚀 מערכת הפעלה

### MTConnect-HTTPS-SILENT-Launcher.exe

**נוצר מ:** `MTConnect-Launcher-Silent.ps1`
**טכנולוגיה:** PowerShell → EXE (ps2exe)

**פעולות אוטומטיות בהפעלה:**
1. **עצירת תהליכים ישנים**
   - סגירת מתאמי FANUC (fanuc_0id.exe, fanuc_18i.exe)
   - סגירת Edge Gateway (node.exe)
   - שחרור פורטים 7701-7708, 3555

2. **הפעלת מתאמי FANUC במצב נסתר**
   - M_1_XD-20: fanuc_0id.exe על פורט 7701
   - M_2_SR_26: fanuc_0id.exe על פורט 7702
   - M_3_XD_38: fanuc_0id.exe על פורט 7703
   - M_4_SR_10: fanuc_0id.exe על פורט 7704
   - M_5_DT_26: fanuc_0id.exe על פורט 7705
   - M_6_SR_21: fanuc_0id.exe על פורט 7706
   - M_7_SR_23: fanuc_18i.exe על פורט 7707
   - M_8_SR_25: fanuc_18i.exe על פורט 7708

3. **הפעלת Edge Gateway**
   - הגדרת משתני סביבה:
     - `CLOUD_API_URL=https://mtconnect-core-production.up.railway.app`
     - `EDGE_GATEWAY_ID=COMPUTERNAME-edge-gateway`
   - הפעלה דרך `npx ts-node src/main.ts`
   - תהליך נסתר לחלוטין (דרך VBScript)

4. **אימות מערכת**
   - בדיקת פורטים 7701-7708 (מתאמי FANUC)
   - בדיקת פורט 3555 (Edge Gateway)
   - דוח סטטוס הפעלה

5. **פתיחה אוטומטית של דשבורד**
   - הפעלת דפדפן עם http://localhost:3555/dashboard-new.html
   - סגירה אוטומטית של חלון ההפעלה אחרי 8 שניות

## 📈 זרימת נתונים

```
מכונות FANUC → SHDR → מתאמי FANUC → Edge Gateway
      ↓                                      ↓
מוני ADAM → Modbus TCP → Edge Gateway        │
                                           ↓
                          HTTPS POST /api/ext/data
                                           ↓
                          Railway Cloud API
                                           ↓
                          MongoDB Atlas
                                           ↓
                       Dashboard (GET /api/dashboard/machines)
```

**תדירות עדכונים:**
- Edge Gateway → Cloud API: כל 10 שניות
- עדכוני דשבורד: כל 5 שניות
- מתאמי FANUC: מצב זמן אמת
- מוני ADAM: כל שתי שניות

## 🌐 ממשקים זמינים

### מקומיים (במחשב Edge Gateway)
- **דשבורד:** http://localhost:3555/dashboard-new.html
- **API:** http://localhost:3555/api/machines

### ענן (זמין בכל מקום)
- **דשבורד:** https://mtconnect-core-production.up.railway.app/dashboard-new.html
- **API:** https://mtconnect-core-production.up.railway.app/api/dashboard/machines

## 🔒 אבטחה

- **HTTPS** לכל החיבורים לענן
- **אימות נתונים** בכל הרמות
- **ניקוי קלט**
- **הגבלת קצב** (Throttling)
- **תיעוד פעולות**
- **בידוד תהליכים** (כל מתאם בנפרד)

## 📊 ביצועים

### מדדים נוכחיים
- **18 מכונות מקוונות** בו זמנית
- **עיבוד ~180 נקודות נתונים** כל 10 שניות
- **זמן תגובת API:** < 200ms
- **זמן טעינת דשבורד:** < 2 שניות
- **נפח נתונים:** ~15KB כל 10 שניות

### יכולת הרחבה
- **Edge Gateway:** עד 50 מכונות לכל Gateway
- **Cloud API:** קנה מידה אוטומטי של Railway
- **MongoDB Atlas:** עד טרה-בייט של נתונים
- **דשבורד:** תמיכה בעד 100 מכונות בממשק

## 🛠️ דרישות טכניות

### מחשב מקומי (Edge Gateway)
- **מערכת הפעלה:** Windows 10/11
- **Node.js:** גרסה 18.x או גבוהה יותר
- **זיכרון:** מינימום 4GB
- **רשת:** גישה למכונות ולאינטרנט
- **פורטים:** 3555, 7701-7708 חייבים להיות פנויים

### דרישות רשת
- **מכונות FANUC:** חיבורי TCP/IP על פורטים 8193
- **מכשירי ADAM:** Modbus TCP 192.168.1.120:502
- **אינטרנט:** גישת HTTPS ל-Railway ו-MongoDB Atlas

## 🔧 התקנה והגדרה

### 1. התחלה מהירה
```cmd
# פשוט הרץ את קובץ ה-EXE
MTConnect-HTTPS-SILENT-Launcher.exe
```

### 2. הפעלה ידנית (לפיתוח)
```powershell
# התקן תלויות
pnpm install

# הגדר משתני סביבה
$env:CLOUD_API_URL = "https://mtconnect-core-production.up.railway.app"
$env:EDGE_GATEWAY_ID = "my-edge-gateway"

# הפעל Edge Gateway
npx ts-node src/main.ts
```

### 3. הגדרת Railway (למנהלים)
```bash
# התקן Railway CLI
npm install -g @railway/cli

# התחבר לפרויקט
railway login
railway link

# פרסם שינויים
git push origin main
```

## 📋 ניטור ואבחון

### בדיקת מערכת
```powershell
# בדוק תהליכים פעילים
Get-Process -Name "node","fanuc_0id","fanuc_18i"

# בדוק פורטים תפוסים
Get-NetTCPConnection -LocalPort 3555,7701,7702,7703,7704,7705,7706,7707,7708 -State Listen

# בדוק API
Invoke-WebRequest -Uri "http://localhost:3555/api/machines"
```

### לוגים ודיבוג
- **Edge Gateway:** לוגי קונסול בהפעלה ידנית
- **Cloud API:** לוגים זמינים ב-Railway Dashboard
- **מתאמי FANUC:** תהליכים נסתרים, לוגים בקבצי המתאמים
- **MongoDB:** לוגים זמינים ב-Atlas Dashboard

## 🎯 מדדי מערכת מרכזיים

### אינדיקטורים נוכחיים (בהפעלה)
- **סה"כ מכונות:** 18
- **מכונות FANUC מקוונות:** 8/8 (100%)
- **מוני ADAM מקוונים:** 10/10 (100%)
- **סה"כ ספריית חלקים:** > 6 מיליון
- **המכונה הפעילה ביותר:** M_2_SR_26 (1,999,667 חלקים)
- **מכונה עם זמן מחזור הטוב ביותר:** M_4_SR_10 (20.19 שנ'/חלק)

### תוכניות טיפוסיות בפעולה
- **1244-01-1** (SR-26) - תוכנית פעילה
- **1327-01** (SR-10) - תוכנית פעילה  
- **634-04** (DT-26) - תוכנית פעילה
- **1374-03** (XD-20) - תוכנית עצורה

## 🚀 פיתוח המערכת

### תכונות מיושמות ✅
- איסוף נתונים בזמן אמת
- אחסון נתונים בענן
- ממשק ניטור ווב
- הפעלה אוטומטית של המערכת
- אבטחת HTTPS
- ארכיטקטורה ניתנת להרחבה

### תוכניות פיתוח 🔮
- התרעות והודעות כשל
- דוחות והפחתת היסטוריים
- אפליקציה ניידת
- אינטגרציה למערכות ERP
- אנליטיקה חזויה
- סוגי ציוד נוספים

## 📞 תמיכה

המערכת מתוכננת ומוגדרת לפעולה יציבה 24/7.

**במקרה של בעיות:**
1. בדוק סטטוס דשבורד
2. הפעל מחדש MTConnect-HTTPS-SILENT-Launcher.exe
3. בדוק חיבורי רשת
4. פנה למנהל טכני

---

*תיעוד נוצר: 29 בינואר 2025*  
*גרסת מערכת: 1.3*  
*סטטוס: ייצור, פונקציונלי במלואו* 