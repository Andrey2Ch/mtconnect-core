# 🏭 MTConnect Industrial Data Collection System

## 📋 Обзор системы

MTConnect система представляет собой комплексное решение для сбора, обработки и мониторинга данных промышленного оборудования в реальном времени. Система работает по архитектуре Edge-to-Cloud, обеспечивая надежный сбор данных на локальном уровне и централизованное хранение в облаке.

## 🏗️ Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    ОБЛАЧНАЯ ЧАСТЬ (Railway)                 │
├─────────────────────────────────────────────────────────────┤
│  ☁️ Cloud API (NestJS)          📊 Dashboard               │
│  - Прием данных от Edge         - Веб-интерфейс мониторинга │
│  - REST API endpoints           - Реальное время обновления │
│  - Валидация и логирование      - Статистика по машинам     │
│                                                             │
│  🗄️ MongoDB Atlas                                          │
│  - Хранение временных рядов     - Индексы для быстрого     │
│  - Метаданные машин             поиска                     │
│  - История операций             - Автоматическое масштабир.│
└─────────────────────────────────────────────────────────────┘
                                │
                          HTTPS/Internet
                                │
┌─────────────────────────────────────────────────────────────┐
│                    ЛОКАЛЬНАЯ ЧАСТЬ (Edge)                   │
├─────────────────────────────────────────────────────────────┤
│  🚀 Edge Gateway (Node.js/TypeScript)                      │
│  - Сбор данных от всех источников                          │
│  - Агрегация и предобработка                               │
│  - Отправка в облако каждые 10 сек                         │
│  - Локальный REST API (порт 3555)                          │
│  - Локальный веб-дашборд                                   │
└─────────────────────────────────────────────────────────────┘
                    │                      │
              ┌─────────────┐        ┌─────────────┐
              │   FANUC     │        │    ADAM     │
              │  Станки     │        │ Счетчики    │
              └─────────────┘        └─────────────┘
```

## 🔧 Компоненты системы

### 1. 🏭 Промышленное оборудование

#### FANUC CNC Станки (8 штук)
- **M_1_XD-20** - Токарный станок XD-20
- **M_2_SR_26** - Фрезерный станок SR-26  
- **M_3_XD_38** - Токарный станок XD-38
- **M_4_SR_10** - Фрезерный станок SR-10
- **M_5_DT_26** - Сверлильный станок DT-26
- **M_6_SR_21** - Фрезерный станок SR-21
- **M_7_SR_23** - Фрезерный станок SR-23
- **M_8_SR_25** - Фрезерный станок SR-25

**Собираемые данные:**
- Количество изготовленных деталей
- Номер выполняемой программы
- Статус выполнения (ACTIVE/STOPPED/READY)
- Время цикла обработки
- Состояние соединения

#### ADAM-6050 Счетчики деталей (10 штук)
- **SR-22** - Счетчик линии SR-22
- **SB-16** - Счетчик линии SB-16
- **BT-38** - Счетчик линии BT-38
- **K-162** - Счетчик линии K-162
- **K-163** - Счетчик линии K-163
- **L-20** - Счетчик линии L-20
- **K-16** - Счетчик линии K-16
- **SR-20** - Счетчик линии SR-20
- **SR-32** - Счетчик линии SR-32
- **SR-24** - Счетчик линии SR-24

**Протокол:** Modbus TCP (192.168.1.120:502)
**Собираемые данные:**
- Счетчики произведенных деталей
- Время цикла (для некоторых линий)
- Статус соединения

### 2. 🖥️ Edge Gateway (Локальный сервер)

**Технологии:** Node.js, TypeScript, Express.js
**Порт:** 3555
**Файл:** `src/main.ts`

**Основные функции:**
- Сбор данных от FANUC адаптеров через SHDR протокол
- Чтение данных ADAM-6050 через Modbus TCP
- Агрегация и валидация данных
- Отправка в облако каждые 10 секунд
- Локальный REST API для мониторинга
- Веб-дашборд для локального просмотра

**API Endpoints:**
- `GET /api/machines` - Список всех машин с данными
- `GET /dashboard-new.html` - Веб-интерфейс

### 3. ☁️ Cloud API (Railway)

**Технологии:** NestJS, TypeScript, MongoDB
**URL:** https://mtconnect-core-production.up.railway.app
**Файлы:** `apps/cloud-api/`

**Основные функции:**
- Прием данных от Edge Gateway
- Сохранение в MongoDB Atlas
- REST API для клиентских приложений
- Валидация и логирование
- Обработка ошибок и восстановление

**API Endpoints:**
- `POST /api/ext/data` - Прием данных от Edge Gateway
- `GET /api/dashboard/machines` - Получение данных для дашборда
- `GET /dashboard-new.html` - Веб-дашборд

### 4. 🗄️ База данных (MongoDB Atlas)

**Коллекция:** `machinedatas`
**Структура документа:**
```json
{
  "timestamp": "2025-01-29T13:10:42.115Z",
  "metadata": {
    "edgeGatewayId": "ANDREY-PC-edge-gateway",
    "machineId": "M_2_SR_26",
    "machineName": "SR-26", 
    "machineType": "FANUC"
  },
  "data": {
    "partCount": 1999667,
    "program": "1244-01-1",
    "executionStatus": "ACTIVE",
    "cycleTime": 20.19,
    "cycleTimeConfidence": "ВЫСОКАЯ"
  }
}
```

**Индексы:**
- `metadata.machineId` + `timestamp` (для быстрого поиска последних данных)
- `metadata.edgeGatewayId` + `timestamp` (для группировки по Edge Gateway)

### 5. 📊 Dashboard (Веб-интерфейс)

**Технологии:** HTML5, CSS3, JavaScript (Vanilla)
**Файл:** `apps/cloud-api/public/dashboard-new.html`

**Функции:**
- Отображение всех 18 машин в реальном времени
- Статистика: онлайн/офлайн, общее количество
- Детальная информация по каждой машине
- Автообновление каждые 5 секунд
- Адаптивный дизайн для мобильных устройств

**Отображаемые данные:**
- Статус соединения (онлайн/офлайн)
- Количество произведенных деталей
- Номер выполняемой программы (FANUC)
- Статус выполнения (ACTIVE/STOPPED/READY)
- Время цикла обработки
- Последнее обновление данных

## 🚀 Система запуска

### MTConnect-HTTPS-SILENT-Launcher.exe

**Создан из:** `MTConnect-Launcher-Silent.ps1`
**Технология:** PowerShell → EXE (ps2exe)

**Автоматические действия при запуске:**
1. **Остановка старых процессов**
   - Завершение FANUC адаптеров (fanuc_0id.exe, fanuc_18i.exe)
   - Завершение Edge Gateway (node.exe)
   - Освобождение портов 7701-7708, 3555

2. **Запуск FANUC адаптеров в скрытом режиме**
   - M_1_XD-20: fanuc_0id.exe на порту 7701
   - M_2_SR_26: fanuc_0id.exe на порту 7702
   - M_3_XD_38: fanuc_0id.exe на порту 7703
   - M_4_SR_10: fanuc_0id.exe на порту 7704
   - M_5_DT_26: fanuc_0id.exe на порту 7705
   - M_6_SR_21: fanuc_0id.exe на порту 7706
   - M_7_SR_23: fanuc_18i.exe на порту 7707
   - M_8_SR_25: fanuc_18i.exe на порту 7708

3. **Запуск Edge Gateway**
   - Установка переменных окружения:
     - `CLOUD_API_URL=https://mtconnect-core-production.up.railway.app`
     - `EDGE_GATEWAY_ID=COMPUTERNAME-edge-gateway`
   - Запуск через `npx ts-node src/main.ts`
   - Полностью скрытый процесс (через VBScript)

4. **Верификация системы**
   - Проверка портов 7701-7708 (FANUC адаптеры)
   - Проверка порта 3555 (Edge Gateway)
   - Отчет о статусе запуска

5. **Автоматическое открытие дашборда**
   - Запуск браузера с http://localhost:3555/dashboard-new.html
   - Автозакрытие окна лаунчера через 8 секунд

## 📈 Поток данных

```
FANUC Станки → SHDR → FANUC Адаптеры → Edge Gateway
     ↓                                      ↓
ADAM Счетчики → Modbus TCP → Edge Gateway   │
                                           ↓
                           HTTPS POST /api/ext/data
                                           ↓
                           Railway Cloud API
                                           ↓
                           MongoDB Atlas
                                           ↓
                        Dashboard (GET /api/dashboard/machines)
```

**Частота обновлений:**
- Edge Gateway → Cloud API: каждые 10 секунд
- Dashboard обновление: каждые 5 секунд
- FANUC адаптеры: в режиме реального времени
- ADAM счетчики: каждые 2 секунды

## 🌐 Доступные интерфейсы

### Локальные (на компьютере с Edge Gateway)
- **Дашборд:** http://localhost:3555/dashboard-new.html
- **API:** http://localhost:3555/api/machines

### Облачные (доступны везде)
- **Дашборд:** https://mtconnect-core-production.up.railway.app/dashboard-new.html
- **API:** https://mtconnect-core-production.up.railway.app/api/dashboard/machines

## 🔒 Безопасность

- **HTTPS** для всех облачных соединений
- **Валидация данных** на всех уровнях
- **Санитизация** входящих данных
- **Ограничение скорости** запросов (Throttling)
- **Логирование** всех операций
- **Изоляция процессов** (каждый адаптер отдельно)

## 📊 Производительность

### Текущие показатели
- **18 машин онлайн** одновременно
- **Обработка ~180 точек данных** каждые 10 секунд
- **Время отклика API:** < 200ms
- **Время загрузки дашборда:** < 2 секунды
- **Объем данных:** ~15KB каждые 10 секунд

### Масштабируемость
- **Edge Gateway:** до 50 машин на один Gateway
- **Cloud API:** автоматическое масштабирование Railway
- **MongoDB Atlas:** до терабайтов данных
- **Dashboard:** поддержка до 100 машин в интерфейсе

## 🛠️ Технические требования

### Локальный компьютер (Edge Gateway)
- **ОС:** Windows 10/11
- **Node.js:** версия 18.x или выше
- **RAM:** минимум 4GB
- **Сеть:** доступ к станкам и интернету
- **Порты:** 3555, 7701-7708 должны быть свободны

### Сетевые требования
- **FANUC станки:** TCP/IP соединения на портах 8193
- **ADAM устройства:** Modbus TCP 192.168.1.120:502
- **Интернет:** HTTPS доступ к Railway и MongoDB Atlas

## 🔧 Установка и настройка

### 1. Быстрый запуск
```cmd
# Просто запустить EXE файл
MTConnect-HTTPS-SILENT-Launcher.exe
```

### 2. Ручной запуск (для разработки)
```powershell
# Установить зависимости
pnpm install

# Установить переменные окружения
$env:CLOUD_API_URL = "https://mtconnect-core-production.up.railway.app"
$env:EDGE_GATEWAY_ID = "my-edge-gateway"

# Запустить Edge Gateway
npx ts-node src/main.ts
```

### 3. Настройка Railway (для администраторов)
```bash
# Установить Railway CLI
npm install -g @railway/cli

# Подключиться к проекту
railway login
railway link

# Задеплоить изменения
git push origin main
```

## 📋 Мониторинг и диагностика

### Проверка системы
```powershell
# Проверить запущенные процессы
Get-Process -Name "node","fanuc_0id","fanuc_18i"

# Проверить занятые порты
Get-NetTCPConnection -LocalPort 3555,7701,7702,7703,7704,7705,7706,7707,7708 -State Listen

# Тест API
Invoke-WebRequest -Uri "http://localhost:3555/api/machines"

# MongoDB (если не запущен):
docker run -d --name mtconnect-mongodb-new -p 27017:27017 mongo:7.0

# Cloud API:
cd apps/cloud-api
pnpm run start:dev

# Проверка 
API: http://localhost:3001/health
Дашборд: http://localhost:3001/dashboard-new.html

# Настройки (уже готовы):
Файл: apps/cloud-api/.env

NODE_ENV=development
PORT=3001
MONGODB_URI=mongodb://localhost:27017/mtconnect-local

# Полная связка (если нужно всё):

## 1. MongoDB
docker run -d --name mtconnect-mongodb-new -p 27017:27017 mongo:7.0

## 2. Edge Gateway (в корне проекта)
npx ts-node src/main.ts

## 3. Cloud API (в новом окне PowerShell)
cd apps/cloud-api
pnpm run start:dev

Результат:
Edge Gateway: http://localhost:3555/dashboard-new.html
Cloud API: http://localhost:3001/dashboard-new.html
```

### Логи и отладка
- **Edge Gateway:** консольные логи при ручном запуске
- **Cloud API:** логи доступны в Railway Dashboard
- **FANUC адаптеры:** скрытые процессы, логи в файлах адаптеров
- **MongoDB:** логи доступны в Atlas Dashboard

## 🎯 Основные метрики системы

### Актуальные показатели (на момент запуска)
- **Общее количество машин:** 18
- **FANUC станки онлайн:** 8/8 (100%)
- **ADAM счетчики онлайн:** 10/10 (100%)
- **Общее количество деталей:** > 6 миллионов
- **Самый активный станок:** M_2_SR_26 (1,999,667 деталей)
- **Станок с лучшим циклом:** M_4_SR_10 (20.19 сек/деталь)

### Типичные программы в работе
- **1244-01-1** (SR-26) - Активная программа
- **1327-01** (SR-10) - Активная программа  
- **634-04** (DT-26) - Активная программа
- **1374-03** (XD-20) - Остановленная программа

## 🚀 Развитие системы

### Реализованные возможности ✅
- Сбор данных в реальном времени
- Облачное хранение данных
- Веб-интерфейс для мониторинга
- Автоматический запуск системы
- HTTPS безопасность
- Масштабируемая архитектура

### Планы развития 🔮
- Алерты и уведомления при сбоях
- Исторические отчеты и аналитика
- Мобильное приложение
- Интеграция с ERP системами
- Предиктивная аналитика
- Дополнительные типы оборудования

## 📞 Поддержка

Система разработана и настроена для стабильной работы 24/7. 

**При возникновении проблем:**
1. Проверить статус дашборда
2. Перезапустить MTConnect-HTTPS-SILENT-Launcher.exe
3. Проверить сетевые соединения
4. Обратиться к техническому администратору

---

*Документация создана: 29 января 2025*  
*Версия системы: 1.3*  
*Статус: Продакшен, полностью функциональная* 