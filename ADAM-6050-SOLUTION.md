# Решение проблемы интеграции Adam-6050 с MTConnect

## Проблема
K-16 и L-20 машины показывали неправильные маленькие значения (57,589 и 2) вместо больших значений счетчиков (8+ миллиардов), хотя в Adam-6050 веб-интерфейсе было видно, что все каналы настроены в Counter Mode.

## Причины проблемы

### 1. Неправильный mapping каналов
**Проблема**: SR-24 был неправильно привязан к каналу DI10 вместо DI11
- **Было**: `10: 'SR-24'` 
- **Стало**: `11: 'SR-24'`

### 2. Неправильный тип Modbus регистров
**Проблема**: Читали Holding Registers (Function Code 03) вместо Input Registers (Function Code 04)
- **Было**: `readHoldingRegisters(0, 12)` 
- **Стало**: `readInputRegisters(0, 24)`

### 3. Неправильная разрядность чтения
**Проблема**: Читали 16-битные значения вместо 32-битных счетчиков
- **Было**: Прямое чтение одного регистра на канал
- **Стало**: Объединение двух 16-битных регистров в один 32-битный

## Решение

### Исправленный mapping каналов
```typescript
this.channelMapping = new Map([
  [0, 'SR-22'],   // DI0 -> SR-22 (SR22)
  [1, 'SB-16'],   // DI1 -> SB-16 (SB16)  
  [2, 'BT-38'],   // DI2 -> BT-38 (BT38)
  [3, 'K-162'],   // DI3 -> K-162 (K-162)
  [4, 'K-163'],   // DI4 -> K-163 (K-163)
  [5, 'L-20'],    // DI5 -> L-20 (L20)
  [6, 'K-16'],    // DI6 -> K-16 (K16)
  [7, ''],        // DI7 -> (не используется)
  [8, 'SR-20'],   // DI8 -> SR-20 (SR20)
  [9, 'SR-32'],   // DI9 -> SR-32 (SR32)
  [10, ''],       // DI10 -> (не используется)
  [11, 'SR-24'],  // DI11 -> SR-24 (SR24) ✅ ИСПРАВЛЕНО
]);
```

### Правильное чтение 32-битных счетчиков
```typescript
// Читаем Input Registers (Function Code 04) для Counter режима
const irResult = await client.readInputRegisters(0, 24); // 24 регистра для 12 32-битных счетчиков
const irValues = irResult.response.body.valuesAsArray;

// Преобразуем 16-битные регистры в 32-битные счетчики
const counters32bit: number[] = [];
for (let i = 0; i < 12; i++) {
  const lowWord = irValues[i * 2];         // Младшие 16 бит
  const highWord = irValues[i * 2 + 1];    // Старшие 16 бит
  const counter32 = lowWord + (highWord * 65536); // Объединяем в 32-битное число
  counters32bit.push(counter32);
}
```

### Использование правильных данных
```typescript
if (counterChannels.has(machineId)) {
  // Counter режим - читаем 32-битные счетчики ✅
  currentCount = counters32bit[i];
  dataType = 'Counter (32-bit)';
}
```

## Результат
✅ **K-16**: теперь показывает ~8,888,580,000+ вместо 57,589  
✅ **L-20**: теперь показывает ~8,888,363,000+ вместо 2  
✅ **SR-24**: теперь читается с правильного канала DI11  
✅ **Все станки**: правильные большие значения счетчиков в миллиардах

## Ключевые выводы
1. **Adam-6050 Counter Mode** хранит данные в **Input Registers** (Function Code 04), а не в Holding Registers
2. **Счетчики 32-битные** - занимают 2 регистра каждый 
3. **Mapping каналов** должен точно соответствовать веб-интерфейсу Adam-6050
4. **Читать нужно 24 регистра** для получения 12 32-битных счетчиков

## Команды для проверки
```bash
# Пересборка и запуск
npm run build
npm start

# Проверка данных
curl http://localhost:5000/adam-data

# Проверка дашборда
http://localhost:5000/dashboard-pro.html
```

## Дата решения
**2024-01-07** - Проблема полностью решена, K-16 и L-20 показывают правильные большие значения. 