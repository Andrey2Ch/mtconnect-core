<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель мониторинга станков</title>
    <style>
        :root {
            --color-bg: #1a1a1c;
            --color-card: #2c2c2e;
            --color-border: #444;
            --color-text: #f0f0f0;
            --color-text-secondary: #aaa;
            --color-green: #28a745;
            --color-yellow: #ffc107;
            --color-red: #dc3545;
            --color-blue: #007bff;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            font-family: var(--font-family-sans-serif);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        h1 {
            margin: 0;
            color: var(--color-text);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #connection-status::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--color-red);
            animation: pulse-red 2s infinite;
        }
        
        #connection-status.connected::before {
            background-color: var(--color-green);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .machines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .machine-card {
            background-color: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .machine-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-blue);
            text-align: center;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 10px;
        }

        .data-point {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
        }

        .data-label {
            color: var(--color-text-secondary);
        }

        .data-value {
            font-weight: bold;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 1em;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .status-executing { background-color: var(--color-green); }
        .status-idle { background-color: var(--color-yellow); color: #333; }
        .status-offline, .status-unavailable, .status-no_data { background-color: var(--color-red); }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--color-text-secondary);
            font-size: 0.9em;
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>Панель мониторинга станков</h1>
        <div class="status-indicator">
            <span id="connection-status"></span>
            <span id="last-updated">Никогда не обновлялось</span>
        </div>
    </div>

    <div id="machines-grid" class="machines-grid">
        <!-- Карточки станков будут вставлены сюда динамически -->
    </div>
    
    <div class="footer">
        Автоматическое обновление каждые 5 секунд
    </div>

    <script>
        const API_URL = '/current';
        const UPDATE_INTERVAL = 5000; // 5 секунд

        const grid = document.getElementById('machines-grid');
        const connectionStatusEl = document.getElementById('connection-status');
        const lastUpdatedEl = document.getElementById('last-updated');

        function getNestedValue(obj, path) {
            try {
                const value = path.split('.').reduce((acc, part) => acc && acc[part], obj);
                return value || 'UNAVAILABLE';
            } catch (e) {
                return 'UNAVAILABLE';
            }
        }
        
        function parseValue(value) {
            if (typeof value === 'object' && value._) {
                return value._;
            }
            if (typeof value === 'string') {
                return value;
            }
            return 'UNAVAILABLE';
        }

        function findComponent(deviceStream, componentName) {
            const streams = Array.isArray(deviceStream.ComponentStream) 
                ? deviceStream.ComponentStream 
                : [deviceStream.ComponentStream];
            return streams.find(cs => getNestedValue(cs, '$.name') === componentName);
        }

        function findDataItem(component, dataItemId) {
             if (!component) return 'UNAVAILABLE';
             
             // Безопасно получаем дочерние элементы Events, Samples, Condition
             const events = component.getElementsByTagName('Events')[0];
             const samples = component.getElementsByTagName('Samples')[0];
             const condition = component.getElementsByTagName('Condition')[0];

             const searchInChildren = (parentElement) => {
                 if (!parentElement) return 'UNAVAILABLE';
                 for (const child of parentElement.children) {
                     if (child.getAttribute('dataItemId') === dataItemId) {
                         return child.textContent;
                     }
                 }
                 return 'UNAVAILABLE';
             }
             
             let result = searchInChildren(events);
             if (result !== 'UNAVAILABLE') return result;

             result = searchInChildren(samples);
             if (result !== 'UNAVAILABLE') return result;

             result = searchInChildren(condition);
             return result;
        }


        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const xmlText = await response.text();
                
                connectionStatusEl.classList.add('connected');
                connectionStatusEl.title = 'Подключено';
                lastUpdatedEl.textContent = `Обновлено: ${new Date().toLocaleTimeString()}`;

                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                
                updateUI(xmlDoc);

            } catch (error) {
                console.error("Ошибка получения данных:", error);
                connectionStatusEl.classList.remove('connected');
                connectionStatusEl.title = `Ошибка: ${error.message}`;
            }
        }

        function updateUI(xmlDoc) {
            const deviceStreams = xmlDoc.getElementsByTagName('DeviceStream');
            const foundMachines = new Set();

            for (const deviceStream of deviceStreams) {
                const machineName = deviceStream.getAttribute('name');
                foundMachines.add(machineName);

                let card = document.getElementById(`machine-${machineName}`);
                if (!card) {
                    card = document.createElement('div');
                    card.className = 'machine-card';
                    card.id = `machine-${machineName}`;
                    grid.appendChild(card);
                }

                const findComponentByName = (name) => {
                    const components = deviceStream.getElementsByTagName('ComponentStream');
                    for(const comp of components) {
                        if(comp.getAttribute('name') === name) {
                            return comp;
                        }
                    }
                    return null;
                }

                // Извлекаем данные
                const pathComponent = findComponentByName('path');
                
                const execution = findDataItem(pathComponent, 'execution');
                const program = findDataItem(pathComponent, 'program');
                const partCount = findDataItem(pathComponent, 'part_count');
                const cycleTime = findDataItem(pathComponent, 'cycle_time_avg'); // <-- ИЩЕМ ВРЕМЯ ЦИКЛА

                // Определяем статус
                let statusText = execution.toUpperCase();
                let statusClass = 'status-unavailable';

                if (statusText === 'ACTIVE' || statusText === 'EXECUTING') {
                    statusClass = 'status-executing';
                } else if (statusText === 'READY' || statusText === 'IDLE' || statusText === 'STOPPED') {
                    statusClass = 'status-idle';
                } else { // UNAVAILABLE, NO_DATA, etc.
                    statusText = 'OFFLINE';
                    statusClass = 'status-offline';
                }

                // Обновляем HTML
                card.innerHTML = `
                    <div class="card-header">${machineName}</div>
                    <div class="data-point">
                        <span class="data-label">Статус:</span>
                        <span class="data-value status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="data-point">
                        <span class="data-label">Программа:</span>
                        <span class="data-value">${program}</span>
                    </div>
                    <div class="data-point">
                        <span class="data-label">Счетчик деталей:</span>
                        <span class="data-value">${partCount}</span>
                    </div>
                    <div class="data-point">
                        <span class="data-label">Время цикла (сек):</span>
                        <span class="data-value">${cycleTime !== 'UNAVAILABLE' ? parseFloat(cycleTime).toFixed(2) : '---'}</span>
                    </div>
                `;
            }

            // Удаляем карточки для станков, которых больше нет в /current
            const machineCards = grid.getElementsByClassName('machine-card');
            for (let i = machineCards.length - 1; i >= 0; i--) {
                const card = machineCards[i];
                const machineName = card.id.replace('machine-', '');
                if (!foundMachines.has(machineName)) {
                    card.remove();
                }
            }
        }
        
        fetchData();
        setInterval(fetchData, UPDATE_INTERVAL);
    </script>
</body>
</html>