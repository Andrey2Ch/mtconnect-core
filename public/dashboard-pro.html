<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель мониторинга станков</title>
    <style>
        :root {
            --color-bg: #1a1a1c;
            --color-card: #2c2c2e;
            --color-border: #444;
            --color-text: #f0f0f0;
            --color-text-secondary: #aaa;
            --color-green: #28a745;
            --color-yellow: #ffc107;
            --color-red: #dc3545;
            --color-blue: #007bff;
            --color-purple: #6f42c1;
            --color-orange: #fd7e14;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            font-family: var(--font-family-sans-serif);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        h1 {
            margin: 0;
            color: var(--color-text);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #connection-status::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--color-red);
            animation: pulse-red 2s infinite;
        }
        
        #connection-status.connected::before {
            background-color: var(--color-green);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .section-title {
            font-size: 1.8em;
            margin: 30px 0 20px 0;
            color: var(--color-text);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 10px;
        }

        .machines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .adam-counters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .connection-card {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: transform 0.2s ease;
        }

        .connection-card:hover {
            transform: translateY(-2px);
        }

        .connection-title {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--color-text-primary);
        }

        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .connection-ok {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--color-green);
        }

        .connection-error {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--color-red);
        }

        .connection-warning {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--color-yellow);
        }

        .connection-details {
            font-size: 0.9em;
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        .machine-card {
            background-color: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .machine-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .adam-card {
            background-color: var(--color-card);
            border: 1px solid var(--color-purple);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .adam-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(111, 66, 193, 0.3);
        }
        
        .card-header {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-blue);
            text-align: center;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 10px;
        }

        .adam-header {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--color-purple);
            text-align: center;
            border-bottom: 1px solid var(--color-purple);
            padding-bottom: 8px;
        }

        .data-point {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
        }

        .adam-data-point {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
        }

        .data-label {
            color: var(--color-text-secondary);
        }

        .data-value {
            font-weight: bold;
        }

        .adam-counter {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--color-orange);
            text-align: center;
            padding: 10px;
            background-color: rgba(253, 126, 20, 0.1);
            border-radius: 5px;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 1em;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .status-executing { background-color: var(--color-green); }
        .status-idle { background-color: var(--color-yellow); color: #333; }
        .status-offline, .status-unavailable, .status-no_data { background-color: var(--color-red); }

        .adam-status {
            text-align: center;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .adam-online {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--color-green);
        }

        .adam-offline {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--color-red);
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--color-text-secondary);
            font-size: 0.9em;
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>Панель мониторинга станков</h1>
        <div class="status-indicator">
            <span id="connection-status"></span>
            <span id="last-updated">Никогда не обновлялось</span>
        </div>
    </div>

    <!-- Статус соединений -->
    <div class="section-title">Статус соединений</div>
    <div id="connection-status-grid" class="connections-grid">
        <!-- Статус соединений будет вставлен сюда динамически -->
    </div>

    <div class="section-title">MTConnect Станки</div>
    <div id="machines-grid" class="machines-grid">
        <!-- Карточки станков будут вставлены сюда динамически -->
    </div>

    <div class="section-title">Счетчики деталей Adam-6050</div>
    <div id="adam-counters-grid" class="adam-counters-grid">
        <!-- Карточки счетчиков Adam будут вставлены сюда динамически -->
    </div>
    
    <div class="footer">
        Автоматическое обновление каждые 5 секунд
    </div>

    <script>
        const API_URL = '/current';
        const ADAM_API_URL = '/api/adam/counters';
        const STATUS_API_URL = '/status';
        const UPDATE_INTERVAL = 5000; // 5 секунд

        const grid = document.getElementById('machines-grid');
        const adamGrid = document.getElementById('adam-counters-grid');
        const connectionsGrid = document.getElementById('connection-status-grid');
        const connectionStatusEl = document.getElementById('connection-status');
        const lastUpdatedEl = document.getElementById('last-updated');

        function getNestedValue(obj, path) {
            try {
                const value = path.split('.').reduce((acc, part) => acc && acc[part], obj);
                return value || 'UNAVAILABLE';
            } catch (e) {
                return 'UNAVAILABLE';
            }
        }
        
        function parseValue(value) {
            if (typeof value === 'object' && value._) {
                return value._;
            }
            if (typeof value === 'string') {
                return value;
            }
            return 'UNAVAILABLE';
        }

        function findComponent(deviceStream, componentName) {
            const streams = Array.isArray(deviceStream.ComponentStream) 
                ? deviceStream.ComponentStream 
                : [deviceStream.ComponentStream];
            return streams.find(cs => getNestedValue(cs, '$.name') === componentName);
        }

        function findDataItem(component, dataItemId) {
             if (!component) return 'UNAVAILABLE';
             
             // Безопасно получаем дочерние элементы Events, Samples, Condition
             const events = component.getElementsByTagName('Events')[0];
             const samples = component.getElementsByTagName('Samples')[0];
             const condition = component.getElementsByTagName('Condition')[0];

             const searchInChildren = (parentElement) => {
                 if (!parentElement) return 'UNAVAILABLE';
                 for (const child of parentElement.children) {
                     if (child.getAttribute('dataItemId') === dataItemId) {
                         return child.textContent;
                     }
                 }
                 return 'UNAVAILABLE';
             }
             
             let result = searchInChildren(events);
             if (result !== 'UNAVAILABLE') return result;

             result = searchInChildren(samples);
             if (result !== 'UNAVAILABLE') return result;

             result = searchInChildren(condition);
             return result;
        }

        async function fetchMTConnectData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                
                updateMTConnectUI(xmlDoc);
                return true;

            } catch (error) {
                console.error("Ошибка получения данных MTConnect:", error);
                return false;
            }
        }

        async function fetchAdamData() {
            try {
                const response = await fetch(ADAM_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                updateAdamUI(data);
                return true;

            } catch (error) {
                console.error("Ошибка получения данных Adam:", error);
                updateAdamUI({ error: error.message });
                return false;
            }
        }

        async function fetchConnectionsStatus() {
            try {
                const response = await fetch(STATUS_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                updateConnectionsUI(data);
                return true;

            } catch (error) {
                console.error("Ошибка получения статуса соединений:", error);
                return false;
            }
        }

        async function fetchData() {
            const mtConnectOk = await fetchMTConnectData();
            const adamOk = await fetchAdamData();
            const connectionsOk = await fetchConnectionsStatus();
            
            if (mtConnectOk || adamOk) {
                connectionStatusEl.classList.add('connected');
                connectionStatusEl.title = 'Подключено';
                lastUpdatedEl.textContent = `Обновлено: ${new Date().toLocaleTimeString()}`;
            } else {
                connectionStatusEl.classList.remove('connected');
                connectionStatusEl.title = 'Ошибка подключения';
            }
        }

        function updateMTConnectUI(xmlDoc) {
            const deviceStreams = xmlDoc.getElementsByTagName('DeviceStream');
            const foundMachines = new Set();

            for (const deviceStream of deviceStreams) {
                const machineName = deviceStream.getAttribute('name');
                foundMachines.add(machineName);

                let card = document.getElementById(`machine-${machineName}`);
                if (!card) {
                    card = document.createElement('div');
                    card.className = 'machine-card';
                    card.id = `machine-${machineName}`;
                    grid.appendChild(card);
                }

                const findComponentByName = (name) => {
                    const components = deviceStream.getElementsByTagName('ComponentStream');
                    for(const comp of components) {
                        if(comp.getAttribute('name') === name) {
                            return comp;
                        }
                    }
                    return null;
                }

                // Извлекаем данные
                const pathComponent = findComponentByName('path');
                
                const execution = findDataItem(pathComponent, 'execution');
                const program = findDataItem(pathComponent, 'program');
                const partCount = findDataItem(pathComponent, 'part_count');
                const cycleTime = findDataItem(pathComponent, 'cycle_time_avg');

                // Определяем статус
                let statusText = execution.toUpperCase();
                let statusClass = 'status-unavailable';

                if (statusText === 'ACTIVE' || statusText === 'EXECUTING') {
                    statusClass = 'status-executing';
                } else if (statusText === 'READY' || statusText === 'IDLE' || statusText === 'STOPPED') {
                    statusClass = 'status-idle';
                } else { // UNAVAILABLE, NO_DATA, etc.
                    statusText = 'OFFLINE';
                    statusClass = 'status-offline';
                }

                // Обновляем HTML
                card.innerHTML = `
                    <div class="card-header">${machineName}</div>
                    <div class="data-point">
                        <span class="data-label">Статус:</span>
                        <span class="data-value status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="data-point">
                        <span class="data-label">Программа:</span>
                        <span class="data-value">${program}</span>
                    </div>
                    <div class="data-point">
                        <span class="data-label">Счетчик деталей:</span>
                        <span class="data-value">${partCount}</span>
                    </div>
                    <div class="data-point">
                        <span class="data-label">Время цикла (сек):</span>
                        <span class="data-value">${cycleTime !== 'UNAVAILABLE' ? parseFloat(cycleTime).toFixed(2) : '---'}</span>
                    </div>
                `;
            }

            // Удаляем карточки для станков, которых больше нет в /current
            const machineCards = grid.getElementsByClassName('machine-card');
            for (let i = machineCards.length - 1; i >= 0; i--) {
                const card = machineCards[i];
                const machineName = card.id.replace('machine-', '');
                if (!foundMachines.has(machineName)) {
                    card.remove();
                }
            }
        }

        function updateAdamUI(data) {
            // Очищаем предыдущие карточки
            adamGrid.innerHTML = '';

            if (data.error) {
                const errorCard = document.createElement('div');
                errorCard.className = 'adam-card';
                errorCard.innerHTML = `
                    <div class="adam-header">Ошибка Adam-6050</div>
                    <div class="adam-status adam-offline">Не удалось подключиться</div>
                    <div class="adam-data-point">
                        <span class="data-label">Ошибка:</span>
                        <span class="data-value">${data.error}</span>
                    </div>
                `;
                adamGrid.appendChild(errorCard);
                return;
            }

            if (data.counters && data.counters.length > 0) {
                data.counters.forEach(counter => {
                    const card = document.createElement('div');
                    card.className = 'adam-card';
                    card.id = `adam-${counter.machineId}`;
                    
                    // Определяем статус активности
                    let activityStatus = 'adam-online';
                    let activityText = 'Онлайн';
                    
                    if (counter.cycleTimeMs && counter.confidence === 'ВЫСОКАЯ') {
                        activityStatus = 'adam-producing';
                        activityText = 'ПРОИЗВОДИТ';
                    } else if (counter.cycleTimeMs && counter.confidence === 'СРЕДНЯЯ') {
                        activityStatus = 'adam-active';
                        activityText = 'АКТИВЕН';
                    } else if (counter.partsInCycle && counter.partsInCycle > 0) {
                        activityStatus = 'adam-active';
                        activityText = 'НАБОР ДАННЫХ';
                    }
                    
                    card.innerHTML = `
                        <div class="adam-header">${counter.machineId}</div>
                        <div class="adam-status ${activityStatus}">${activityText}</div>
                        <div class="adam-counter">${counter.count.toLocaleString()}</div>
                        <div class="adam-data-point">
                            <span class="data-label">Канал:</span>
                            <span class="data-value">${counter.channel}</span>
                        </div>
                        <div class="adam-data-point">
                            <span class="data-label">Время цикла:</span>
                            <span class="data-value">${counter.cycleTimeMs ? (counter.cycleTimeMs / 1000).toFixed(2) + ' сек' : 'Расчет...'}</span>
                        </div>
                        <div class="adam-data-point">
                            <span class="data-label">Данных для расчета:</span>
                            <span class="data-value">${counter.partsInCycle || 0} деталей</span>
                        </div>
                        <div class="adam-data-point">
                            <span class="data-label">Точность:</span>
                            <span class="data-value">${counter.confidence || 'Набор данных'}</span>
                        </div>
                        <div class="adam-data-point">
                            <span class="data-label">Обновлено:</span>
                            <span class="data-value">${new Date(counter.timestamp).toLocaleTimeString()}</span>
                        </div>
                    `;
                    
                    adamGrid.appendChild(card);
                });
            } else {
                const noDataCard = document.createElement('div');
                noDataCard.className = 'adam-card';
                noDataCard.innerHTML = `
                    <div class="adam-header">Adam-6050</div>
                    <div class="adam-status adam-offline">Нет данных</div>
                    <div class="adam-data-point">
                        <span class="data-label">Статус:</span>
                        <span class="data-value">Счетчики не найдены</span>
                    </div>
                `;
                adamGrid.appendChild(noDataCard);
            }
        }

        function updateConnectionsUI(data) {
            // Очищаем предыдущие карточки
            connectionsGrid.innerHTML = '';

            // Карточка сервера
            const serverCard = document.createElement('div');
            serverCard.className = 'connection-card';
            serverCard.innerHTML = `
                <div class="connection-title">Основной сервер</div>
                <div class="connection-status connection-ok">РАБОТАЕТ</div>
                <div class="connection-details">
                    Время работы: ${Math.floor(data.server.uptime / 3600)}ч ${Math.floor((data.server.uptime % 3600) / 60)}м<br>
                    Память: ${(data.server.memory.heapUsed / 1024 / 1024).toFixed(1)} MB
                </div>
            `;
            connectionsGrid.appendChild(serverCard);

            // Карточка Adam-6050
            const adamCard = document.createElement('div');
            adamCard.className = 'connection-card';
            const adamStatus = data.adam6050.status === 'OK' ? 'connection-ok' : 'connection-error';
            const adamStatusText = data.adam6050.status === 'OK' ? 'ПОДКЛЮЧЕН' : 'ОШИБКА';
            
            adamCard.innerHTML = `
                <div class="connection-title">Adam-6050 (${data.adam6050.host})</div>
                <div class="connection-status ${adamStatus}">${adamStatusText}</div>
                <div class="connection-details">
                    Счетчиков: ${data.adam6050.counters}<br>
                    ${data.adam6050.error ? `Ошибка: ${data.adam6050.error}` : 'Modbus/TCP активен'}
                </div>
            `;
            connectionsGrid.appendChild(adamCard);

            // Карточки MTConnect агентов
            if (data.mtconnectAgents) {
                const agentGroups = {};
                data.mtconnectAgents.forEach(agent => {
                    const status = agent.status;
                    if (!agentGroups[status]) {
                        agentGroups[status] = [];
                    }
                    agentGroups[status].push(agent);
                });

                Object.keys(agentGroups).forEach(status => {
                    const agents = agentGroups[status];
                    const agentCard = document.createElement('div');
                    agentCard.className = 'connection-card';
                    
                    let statusClass = 'connection-warning';
                    let statusText = status;
                    
                    if (status === 'OK') {
                        statusClass = 'connection-ok';
                        statusText = `${agents.length} АГЕНТОВ АКТИВНО`;
                    } else if (status === 'ERROR') {
                        statusClass = 'connection-error';
                        statusText = `${agents.length} АГЕНТОВ НЕДОСТУПНО`;
                    } else if (status === 'NO_AGENT') {
                        statusClass = 'connection-warning';
                        statusText = `${agents.length} БЕЗ АГЕНТОВ`;
                    }
                    
                    const agentsList = agents.map(agent => {
                        const responseInfo = agent.responseTime > 0 ? ` (${agent.responseTime}ms)` : '';
                        return `${agent.name}${responseInfo}`;
                    }).join('<br>');
                    
                    agentCard.innerHTML = `
                        <div class="connection-title">MTConnect Агенты</div>
                        <div class="connection-status ${statusClass}">${statusText}</div>
                        <div class="connection-details">${agentsList}</div>
                    `;
                    connectionsGrid.appendChild(agentCard);
                });
            }
        }
        
        fetchData();
        setInterval(fetchData, UPDATE_INTERVAL);
    </script>
</body>
</html>