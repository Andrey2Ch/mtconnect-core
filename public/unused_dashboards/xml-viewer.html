<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Viewer - MTConnect Data</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .machine-selector {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        .status {
            padding: 10px 20px;
            background: #ecf0f1;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        .status.loading {
            background: #f39c12;
            color: white;
        }
        .status.error {
            background: #e74c3c;
            color: white;
        }
        .status.success {
            background: #27ae60;
            color: white;
        }
        .xml-content {
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin: 20px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .xml-content.formatted {
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .xml-tag {
            color: #569cd6;
        }
        .xml-attr {
            color: #9cdcfe;
        }
        .xml-value {
            color: #ce9178;
        }
        .xml-text {
            color: #d4d4d4;
        }
        .machine-info {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            align-items: center;
        }
        .info-item {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #xmlData {
            min-height: 400px;
            max-height: 800px;
            overflow-y: auto;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #e8f5e8;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç XML Viewer - MTConnect Raw Data</h1>
            <p>–ü—Ä–æ—Å–º–æ—Ç—Ä —Å—ã—Ä—ã—Ö XML –¥–∞–Ω–Ω—ã—Ö —Å MTConnect –∞–≥–µ–Ω—Ç–æ–≤</p>
        </div>

        <div class="controls">
            <label for="machineSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω–æ–∫:</label>
            <select id="machineSelect" class="machine-selector">
                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
            </select>
            
            <button id="refreshBtn" class="btn btn-primary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button id="formatBtn" class="btn btn-secondary">üìã –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh">
                <label for="autoRefresh">–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (5 —Å–µ–∫)</label>
            </div>
        </div>

        <div id="machineInfo" class="machine-info" style="display: none;">
            <div class="info-item">
                <strong>IP:</strong> <span id="machineIP"></span>
            </div>
            <div class="info-item">
                <strong>–ü–æ—Ä—Ç:</strong> <span id="machinePort"></span>
            </div>
            <div class="info-item">
                <strong>Agent URL:</strong> <span id="machineAgentUrl"></span>
            </div>
        </div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-item">
                <span>–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: </span><span id="dataSize">0</span> –±–∞–π—Ç
            </div>
            <div class="stat-item">
                <span>–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: </span><span id="loadTime">0</span> –º—Å
            </div>
            <div class="stat-item">
                <span>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: </span><span id="lastUpdate">-</span>
            </div>
        </div>

        <div id="status" class="status">
            –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω–æ–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ XML –¥–∞–Ω–Ω—ã—Ö
        </div>

        <div id="xmlData" class="xml-content">
            –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω–æ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ XML –¥–∞–Ω–Ω—ã—Ö...
        </div>
    </div>

    <script>
        let machines = [];
        let currentMachine = null;
        let autoRefreshInterval = null;
        let isFormatted = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–∞—à–∏–Ω
        async function loadMachines() {
            try {
                const response = await fetch('/api/machines');
                machines = await response.json();
                
                const select = document.getElementById('machineSelect');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω–æ–∫...</option>';
                
                machines.forEach(machine => {
                    const option = document.createElement('option');
                    option.value = machine.id;
                    option.textContent = `${machine.name} (${machine.id})${machine.hasAgent ? '' : ' - –ù–ï–¢ –ê–ì–ï–ù–¢–ê'}`;
                    option.disabled = !machine.hasAgent;
                    select.appendChild(option);
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º XD-38 –µ—Å–ª–∏ –µ—Å—Ç—å
                const xd38 = machines.find(m => m.id === 'XD-38');
                if (xd38 && xd38.hasAgent) {
                    select.value = 'XD-38';
                    onMachineSelect();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—à–∏–Ω:', error);
                updateStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–∞—à–∏–Ω', 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –º–∞—à–∏–Ω—ã
        function onMachineSelect() {
            const select = document.getElementById('machineSelect');
            const machineId = select.value;
            
            if (!machineId) {
                currentMachine = null;
                document.getElementById('machineInfo').style.display = 'none';
                document.getElementById('stats').style.display = 'none';
                document.getElementById('xmlData').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω–æ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ XML –¥–∞–Ω–Ω—ã—Ö...';
                updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω–æ–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ XML –¥–∞–Ω–Ω—ã—Ö');
                return;
            }

            currentMachine = machines.find(m => m.id === machineId);
            if (currentMachine) {
                showMachineInfo(currentMachine);
                loadXMLData();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—à–∏–Ω–µ
        function showMachineInfo(machine) {
            document.getElementById('machineIP').textContent = machine.ip;
            document.getElementById('machinePort').textContent = machine.port;
            document.getElementById('machineAgentUrl').textContent = machine.agentUrl;
            document.getElementById('machineInfo').style.display = 'flex';
            document.getElementById('stats').style.display = 'flex';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ XML –¥–∞–Ω–Ω—ã—Ö
        async function loadXMLData() {
            if (!currentMachine) return;

            const startTime = Date.now();
            updateStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${currentMachine.name}...`, 'loading');

            try {
                const response = await fetch(`/api/machine/${currentMachine.id}/xml`);
                const loadTime = Date.now() - startTime;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const xmlData = await response.text();
                const dataSize = new Blob([xmlData]).size;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.getElementById('dataSize').textContent = dataSize.toLocaleString();
                document.getElementById('loadTime').textContent = loadTime;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º XML
                displayXML(xmlData);
                updateStatus(`–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ (${dataSize} –±–∞–π—Ç –∑–∞ ${loadTime} –º—Å)`, 'success');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ XML:', error);
                document.getElementById('xmlData').textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`;
                updateStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ XML
        function displayXML(xmlData) {
            const xmlElement = document.getElementById('xmlData');
            
            if (isFormatted) {
                xmlElement.innerHTML = formatXML(xmlData);
                xmlElement.className = 'xml-content formatted';
            } else {
                xmlElement.textContent = xmlData;
                xmlElement.className = 'xml-content';
            }
        }

        // –ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ XML —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
        function formatXML(xml) {
            return xml
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/&lt;(\/?[^&gt;]+)&gt;/g, '<span class="xml-tag">&lt;$1&gt;</span>')
                .replace(/(\w+)="([^"]*)"/g, '<span class="xml-attr">$1</span>="<span class="xml-value">$2</span>"')
                .replace(/\n/g, '<br>')
                .replace(/  /g, '&nbsp;&nbsp;');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function toggleFormat() {
            isFormatted = !isFormatted;
            const btn = document.getElementById('formatBtn');
            btn.textContent = isFormatted ? 'üìÑ –û–±—ã—á–Ω—ã–π –≤–∏–¥' : 'üìã –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å';
            
            if (currentMachine) {
                const xmlElement = document.getElementById('xmlData');
                const currentXML = xmlElement.textContent || xmlElement.innerText;
                if (currentXML.trim()) {
                    displayXML(currentXML);
                }
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(() => {
                    if (currentMachine) {
                        loadXMLData();
                    }
                }, 5000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('machineSelect').addEventListener('change', onMachineSelect);
        document.getElementById('refreshBtn').addEventListener('click', loadXMLData);
        document.getElementById('formatBtn').addEventListener('click', toggleFormat);
        document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadMachines();
    </script>
</body>
</html> 